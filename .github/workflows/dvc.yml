name: Smart DVC Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - 'data/**/*.dvc'
      - 'dvc.lock'
      - 'src/ingestion/**'
  workflow_dispatch:

jobs:
  dvc-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      AZURE_STORAGE_ACCOUNT_NAME: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}
      AZURE_STORAGE_SAS_TOKEN: ${{ secrets.AZURE_STORAGE_SAS_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install DVC + Azure support
        run: pip install dvc[azure]

      - name: Check if DVC data changed
        id: data_check
        run: |
          if dvc status -c | grep -q 'changed:'; then
            echo "data_changed=true" >> $GITHUB_ENV
          else
            echo "data_changed=false" >> $GITHUB_ENV
          fi

      - name: Run DVC pipeline
        if: env.data_changed == 'true'
        run: |
          echo "ðŸ“¦ Data changed â€” running pipeline..."
          dvc pull
          dvc repro
          dvc push
        continue-on-error: false

      - name: Skip pipeline if no changes
        if: env.data_changed == 'false'
        run: echo "âœ… No data changes detected â€” skipping pipeline."
