services:
  # API Service
  churn-api-jaw:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
    container_name: churn-prediction-api
    ports:
      - "8000:8000"
    volumes:
      - ./models:/app/models
      - ./artifacts:/app/artifacts
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config:/app/config
      - ./mlruns:/app/mlruns  # Add MLflow tracking
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - ENVIRONMENT=production
      - MLFLOW_TRACKING_URI=file:///app/mlruns
      - MODEL_DIR=/app/models
      - DATA_DIR=/app/data
      - POSTGRES_HOST=${POSTGRES_HOST:-localhost}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB_NAME=${POSTGRES_DB_NAME:-churn_db}
      - POSTGRES_DB_USER=${POSTGRES_DB_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
    env_file:
      - .env
    networks:
      - churn-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import requests; requests.get('http://localhost:8000/health', timeout=10)\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Add PostgreSQL service
  postgres:
    image: postgres:13
    container_name: churn-postgres
    environment:
      - POSTGRES_DB=${POSTGRES_DB_NAME:-churn_db}
      - POSTGRES_USER=${POSTGRES_DB_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - churn-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_DB_USER:-postgres}"]
      interval: 30s
      timeout: 10s
      retries: 3


  # Add MLflow service
  mlflow:
    image: python:3.9-slim
    container_name: churn-mlflow
    working_dir: /app
    command: >
      sh -c "pip install mlflow psycopg2-binary &&
             mlflow server --host 0.0.0.0 --port 5000 --backend-store-uri sqlite:///mlflow.db --default-artifact-root ./mlruns"
    ports:
      - "5000:5000"
    volumes:
      - ./mlruns:/app/mlruns
      - ./mlflow.db:/app/mlflow.db
    networks:
      - churn-network
    restart: unless-stopped
    depends_on:
      - churn-api-jaw

volumes:
  postgres_data:

networks:
  churn-network:
    driver: bridge